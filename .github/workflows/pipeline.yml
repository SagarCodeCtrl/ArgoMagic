name: Docker Build, Push, and ArgoCD Refresh

on:
  push:
    branches:
      - main  # Adjust the branch name if necessary
  workflow_dispatch:

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      ARGOSERVER: 'argocd-server.example.com'  # Replace with your ArgoCD server address
      ARGOPORT: '443'  # Replace with your ArgoCD server port
      ARGOAPP: 'fakweb'  # Replace with your ArgoCD application name
      IMAGE_NAME: 'sagarkp/fakeweb'
      DEPLOYMENT_YAML: 'deployment.yml'

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-docker@v2

      - name: Build and push Docker image
        run: |
          docker build -t $IMAGE_NAME:${{ github.run_number }} .
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
          docker push $IMAGE_NAME:${{ github.run_number }}

      - name: Update Deployment YAML
        run: |
          deploymentYAML=$(cat $DEPLOYMENT_YAML)
          updatedYAML=$(echo "$deploymentYAML" | sed "s|image: $IMAGE_NAME:.*|image: $IMAGE_NAME:${{ github.run_number }}|")
          echo "$updatedYAML" > $DEPLOYMENT_YAML

      - name: Push changes to GitHub
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add $DEPLOYMENT_YAML
          git commit -m "Update image tag to $IMAGE_NAME:${{ github.run_number }}"
          git push

      - name: Trigger ArgoCD sync
        run: |
          curl -k -X POST https://${ARGOSERVER}:${ARGOPORT}/api/v1/applications/${ARGOAPP}/sync
